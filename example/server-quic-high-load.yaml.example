# paqet Server Configuration for High Connection Pressure with QUIC
# This configuration is optimized for handling thousands of concurrent connections
role: "server"

# Logging configuration
log:
  level: "info"  # Use "warn" or "error" for very high load to reduce overhead

# Server listen configuration
listen:
  addr: ":9999"   # CHANGE ME: Server listen port (must match network.ipv4.addr port)

# Network interface settings
network:
  interface: "eth0"                          # CHANGE ME: Network interface (eth0, ens3, en0, etc.)
  # guid: "\Device\NPF_{...}"                # Windows only (Npcap).

  # IPv4 configuration
  ipv4:
    addr: "10.0.0.100:9999"                  # CHANGE ME: Server IPv4 and port (port must match listen.addr)
    router_mac: "aa:bb:cc:dd:ee:ff"          # CHANGE ME: Gateway/router MAC address

  # TCP flags for packet crafting
  tcp:
    local_flag: ["PA"]                       # Local TCP flags (Push+Ack default)

# Transport protocol configuration - QUIC optimized for high load
transport:
  protocol: "quic"  # Using QUIC for high performance under pressure
  conn: 1           # Number of connections (1-256, default: 1)

  # QUIC protocol settings optimized for high connection pressure
  quic:
    # Connection settings - INCREASED FOR HIGH LOAD
    max_idle_timeout: 60                # Increased to 60s to prevent premature disconnections
    max_incoming_streams: 50000         # Very high limit for many concurrent streams
                                        # WARNING: Each stream consumes memory (~4-16KB per stream)
                                        # Monitor memory usage and adjust based on available RAM
    max_incoming_uni_streams: 50000     # Very high limit for unidirectional streams
    
    # Flow control settings - OPTIMIZED FOR HIGH BANDWIDTH AND MANY CONNECTIONS
    # These values are significantly increased from defaults
    initial_stream_receive_window: 10485760      # 10 MB (increased from 6 MB)
    max_stream_receive_window: 41943040          # 40 MB (increased from 24 MB)
    initial_connection_receive_window: 31457280  # 30 MB (increased from 15 MB)
    max_connection_receive_window: 104857600     # 100 MB (increased from 60 MB)
    
    # Performance settings
    enable_0rtt: true                   # Enable 0-RTT for faster client reconnections
    keep_alive_period: 15               # Keep-alive every 15s for better dead connection detection
    
    # Note: Server automatically generates a self-signed TLS certificate

# Performance tuning for high connection pressure
performance:
  # CRITICAL: Increase concurrent stream limit for high load
  max_concurrent_streams: 50000         # Allow up to 50k concurrent stream handlers
  
  # Packet processing optimization
  packet_workers: 8                     # Increase based on CPU cores (default: num_cores, min: 4 for servers)
  stream_worker_pool_size: 5000         # Large worker pool for stream handling
  
  # TCP connection pooling for upstream targets - HIGHLY RECOMMENDED
  enable_connection_pooling: true       # Enable to reuse TCP connections
  tcp_connection_pool_size: 500         # Large pool for high-pressure scenarios
  tcp_connection_idle_timeout: 90       # Keep connections for 90s
  
  # Retry configuration for transient failures
  max_retry_attempts: 5
  retry_initial_backoff_ms: 100
  retry_max_backoff_ms: 10000

# Important: Server Firewall Configuration Required!
# 
# Since paqet uses pcap to bypass standard firewalls, you MUST configure
# iptables on the server to prevent kernel interference:
#
# sudo iptables -t raw -A PREROUTING -p tcp --dport 9999 -j NOTRACK
# sudo iptables -t raw -A OUTPUT -p tcp --sport 9999 -j NOTRACK  
# sudo iptables -t mangle -A OUTPUT -p tcp --sport 9999 --tcp-flags RST RST -j DROP
#
# Replace 9999 with your actual listen port.
#
# Additional system tuning recommendations for high load:
#
# 1. Increase file descriptor limits:
#    sudo ulimit -n 1000000
#    Or add to /etc/security/limits.conf:
#    * soft nofile 1000000
#    * hard nofile 1000000
#
# 2. Increase system connection limits:
#    sudo sysctl -w net.core.somaxconn=65535
#    sudo sysctl -w net.ipv4.tcp_max_syn_backlog=65535
#    sudo sysctl -w net.core.netdev_max_backlog=65535
#
# 3. Optimize memory and buffer sizes:
#    sudo sysctl -w net.core.rmem_max=134217728
#    sudo sysctl -w net.core.wmem_max=134217728
#    sudo sysctl -w net.ipv4.tcp_rmem='4096 87380 134217728'
#    sudo sysctl -w net.ipv4.tcp_wmem='4096 65536 134217728'
#
# 4. Enable TCP fast open:
#    sudo sysctl -w net.ipv4.tcp_fastopen=3
#
# 5. Reduce TIME_WAIT connections:
#    sudo sysctl -w net.ipv4.tcp_fin_timeout=15
#    sudo sysctl -w net.ipv4.tcp_tw_reuse=1
#
# To make these changes persistent, add them to /etc/sysctl.conf
